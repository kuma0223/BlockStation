<!-- Riot.js用カレンダーコントロールセット -->

<!-- カレンダーコントロール
    属性 無し
-->
<my-Calendar>
    <div style="display:inline-block;text-align:center">
        <div class="calendarHead">
            <svg add="-12" onclick="{arrowClicked}" width="25" height="25" viewBox="0 0 20 20" class="arrow">
			    <polygon points="3,10, 17,6, 17,14" fill="dimgray" />
            </svg>
            <svg add="-1" onclick="{arrowClicked}" width="25" height="25" viewBox="0 0 20 20" class="arrow">
			    <polygon points="6,10, 14,6, 14,14" fill="dimgray" />
            </svg>
            <span style="vertical-align:middle;display:inline-block">{ headText }</span>
            <svg add="1" onclick="{arrowClicked}" width="25" height="25" viewBox="0 0 20 20" class="arrow">
			    <polygon points="14,10, 6,6, 6,14" fill="dimgray" />
            </svg>
            <svg add="12" onclick="{arrowClicked}" width="25" height="25" viewBox="0 0 20 20" class="arrow">
			    <polygon points="17,10, 3,6, 3,14" fill="dimgray" />
            </svg>
        </div>
        <div style="display: inline-block;width:210px;">
            <div class="week" style="color: orangered">日</div>
            <div class="week">月</div>
            <div class="week">火</div>
            <div class="week">水</div>
            <div class="week">木</div>
            <div class="week">金</div>
            <div class="week" style="color: mediumblue">土</div>
            <div each={ items } name={ name }
                 class={ 'piece':true, 'notThisMonth':!isThisMonth, 'selected':selected }
                 onclick={ pieceClicked }>
                { text }
            </div>
            <div style="visibility:hidden;height:0;clear:both" />
        </div>
    </div>

    <style scoped>
        :scope {
            display: block;
            cursor: default;
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }
        :scope > div {
            background: #FCFCFC;
            border-radius: 3px;
        }
        div.calendarHead {
            width: 230px;
            font-size: 16px;
            text-align: center;
        }
        svg.arrow {
            display: inline-block;
            vertical-align: middle;
            cursor: pointer;
            transition: 0.3s;
            border-radius: 3px;
        }
        svg.arrow:hover {
            background: lightgray;
        }
        div.week, div.piece {
            float: left;
            width: 30px;
            text-align: center;
            background-color: transparent;
        }
        div.week {
            font-size: 14px;
            height: auto;
        }
        div.piece {
            font-size: 16px;
            cursor: pointer;
            border-radius: 3px;
            border: solid 1px transparent;
        }
        div.piece:hover {
            border-color: gray;
        }
        div.piece.notThisMonth {
            opacity:0.5;
        }
        div.piece.selected {
            color: white;
            background-color: darkorange;
        }

    </style>

    <script>
        var me = this;
        this.headText = "yyyy年MM月"
        this.items = [];
        /// <var type="Date" />
        this.value; //選択中の値（それは表示範囲にない場合もある）
        this.nowMonth;

        //----------------------------------------
        //初期化

        function init(){
            for(var i=0; i<42; i++){
                me.items.push({text:i, name:"p"+i, selected:false, value:0, isThisMonth:true});
            }

            var d = new Date();
            me.value = new Date(d.getFullYear(), d.getMonth(), d.getDate());
            //value.setTime(value.getTime() - value.getTime() % 86400000) この丸めは不可（基準が日本時間だと9時）

            setNowMonth(me.value.getFullYear(), me.value.getMonth());
        }
        init();

        //----------------------------------------
        //イベント処理用

        this.pieceClicked = function(event){
            var nm = event.target.getAttribute("name");
            var index = nm.substring(1, nm.length);
            setValue(me.items[index].value);
        }
        this.arrowClicked = function(event){
            var add = event.target.getAttribute("add");
            if(add == undefined){
                add = event.target.parentNode.getAttribute("add");
            }
            var d = new Date(me.nowMonth.getTime());
            d.setMonth(d.getMonth() + Number(add));
            setNowMonth(d.getFullYear(), d.getMonth());
        }

        //----------------------------------------

        function setNowMonth(year, month){
            if(me.nowMonth != undefined && me.nowMonth.getFullYear() == year && me.nowMonth.getMonth() == month ){
                return;
            }

            me.nowMonth = new Date(year, month, 1);
            me.headText = ("0000"+year).substr(-4) + "年" + ("00"+ (month+1)).substr(-2) + "月";

            var day = new Date(year, month, 1, 0, 0, 0, 0);
            while(day.getDay() != 0){ //最初の日曜日まで遡る。
                day.setDate(day.getDate()-1);
            }
            me.items.forEach(function(item){
                item.text = day.getDate();
                item.value = day.getTime();
                item.isThisMonth = day.getMonth() == month;
                day.setDate(day.getDate() + 1);
            });
            setItemSelected();
        }
        
        function setItemSelected(){
            me.items.forEach(function(item){
                item.selected = item.value == me.value.getTime();
            });
        }

        function setValue(millis){
            if(me.value.getTime() == millis) return;
            me.value.setTime(millis);
            setNowMonth(me.value.getFullYear(), me.value.getMonth());
            setItemSelected();
            me.update();
            me.onValueChanged(me);
        }

        //----------------------------------------
        //公開メソッド

        /**
         * 選択日付取得
         * @return {Date} 取得値
         */
        this.getValue = function(){
            return new Date(me.value.getTime());
        }
        /**
         * 選択日付設定
         * @param {Date} value 設定値
         */
        this.setValue = function(value){
            var tmp = new Date(value.getFullYear(), value.getMonth(), value.getDate());
            setValue(tmp.getTime());
        }

        //----------------------------------------
        //個別イベントコールバック

        /**
         * 値の変更時に呼び出されます（初期化時は呼ばれません）
         * @param sender このインスタンス
         */
        this.onValueChanged = this.opts.onvaluechanged ? this.opts.onvaluechanged : function(sender){};

    </script>
</my-Calendar>


<!-- 月指定カレンダー
    属性 無し
-->
<my-MCalendar>
    <div style="display:inline-block;text-align:center">
        <div class="calendarHead">
            <svg add="-1" onclick="{arrowClicked}" width="25" height="25" viewBox="0 0 20 20" class="arrow">
			    <polygon points="6,10, 14,6, 14,14" fill="dimgray" />
            </svg>
            <span style="vertical-align:middle;display:inline-block;margin: 0 10px">{ headText }</span>
            <svg add="1" onclick="{arrowClicked}" width="25" height="25" viewBox="0 0 20 20" class="arrow">
			    <polygon points="14,10, 6,6, 6,14" fill="dimgray" />
            </svg>
        </div>
        <div style="display: inline-block; width:210px;">
            <div each={ items } name={ name } class={ 'piece':true, 'selected':selected } onclick={ pieceClicked }>
                { text }
            </div>
            <div style="visibility:hidden;height:0;clear:both" />
        </div>
    </div>

    <style scoped>
        :scope{
            display:block;
            cursor:default;
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }
        :scope > div {
            background: #FCFCFC;
            border-radius: 3px;
        }
        div.calendarHead {
            width: 230px;
            font-size: 16px;
            text-align: center;
        }
        svg.arrow {
            display: inline-block;
            vertical-align: middle;
            cursor: pointer;
            transition: 0.3s;
            border-radius: 3px;
        }
        svg.arrow:hover {
            background: lightgray;
        }
        div.piece {
            float: left;
            width: 52px;
            text-align: center;
            background-color: transparent;
            font-size: 16px;
            cursor: pointer;
            border-radius: 3px;
            border: solid 1px transparent;
            padding: 8px 0;
        }
        div.piece:hover {
            border-color: gray;
        }
        div.piece.selected {
            color: white;
            background-color: darkorange;
        }
    </style>

    <script>
        var me = this;
        this.headText = "yyyy年"
        this.items = [];
        
        /// <var type="Date" />
        this.value; //選択中の値（それは表示範囲にない場合もある）
        this.nowYear = -1;

        //----------------------------------------
        //初期化

        function init(){
            for(var i=0; i<12; i++){
                me.items.push({text:(i+1)+"月", name:"p"+i, selected:false, value:0});
            }

            var d = new Date();
            me.value = new Date(d.getFullYear(), d.getMonth());
            setNowYear(d.getFullYear());
        }
        init();
        
        //----------------------------------------
        //イベント処理用

        this.pieceClicked = function(event){
            var nm = event.target.getAttribute("name");
            var index = Number(nm.substring(1, nm.length));
            setValue(me.items[index].value);
        }
        this.arrowClicked = function(event){
            var add = event.target.getAttribute("add");
            if(add == undefined){
                add = event.target.parentNode.getAttribute("add");
            }
            setNowYear(me.nowYear + Number(add));
        }

        //----------------------------------------

        function setNowYear(year){
            if(me.nowYear == year) return;

            me.nowYear = year;
            me.headText = ("0000"+year).substr(-4) + "年";

            var day = new Date(year, 0, 1, 0, 0, 0, 0);
            me.items.forEach(function(item){
                item.value = day.getTime();
                day.setMonth(day.getMonth() + 1);
            });

            setItemSelected();
        }

        function setItemSelected(){
            me.items.forEach(function(item){
                item.selected = item.value == me.value.getTime();
            });
        }

        function setValue(millis){
            if(me.value.getTime() == millis) return;

            me.value.setTime(millis);
            setNowYear(me.value.getFullYear());
            setItemSelected();

            me.update();
            me.onValueChanged(me);
        }

        //----------------------------------------
        //公開メソッド

        /**
         * 選択月取得
         * @return {Date} 取得値
         */
        this.getValue = function(){
            return new Date(me.value.getTime());
        }
        /**
         * 選択月設定
         * @param {Date} value 設定値
         */
        this.setValue = function(value){
            var tmp = new Date(value.getFullYear(), value.getMonth());
            setValue(tmp.getTime());
        }

        //----------------------------------------
        //個別イベントコールバック

        /**
         * 値の変更時に呼び出されます（初期化時は呼ばれません）
         * @param sender このインスタンス
         */
        this.onValueChanged = this.opts.onvaluechanged ? this.opts.onvaluechanged : function(sender){};

    </script>
</my-MCalendar>


<!-- 年指定カレンダー
    属性 無し
-->
<my-YCalendar>
    <div style="display:inline-block;text-align:center">
        <div class="calendarHead">
            <svg add="-1" onclick="{arrowClicked}" width="25" height="25" viewBox="0 0 20 20" class="arrow">
			    <polygon points="6,10, 14,6, 14,14" fill="dimgray" />
            </svg>
            <span style="vertical-align:middle;display:inline-block;margin:0 10px">{ headText }</span>
            <svg add="1" onclick="{arrowClicked}" width="25" height="25" viewBox="0 0 20 20" class="arrow">
			    <polygon points="14,10, 6,6, 6,14" fill="dimgray" />
            </svg>
        </div>
        <div style="display: inline-block; width:210px;">
            <div each={ items } name={ name } class={ 'piece':true, 'selected':selected } onclick={ pieceClicked }>
                { text }
            </div>
            <p style="display:none;clear:both" />
        </div>
    </div>

    <style scoped>
        :scope{
            display:block;
            cursor:default;
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }
        :scope > div {
            background: #FCFCFC;
            border-radius: 3px;
        }
        div.calendarHead {
            width: 230px;
            font-size: 16px;
            text-align: center;
        }
        svg.arrow {
            display: inline-block;
            vertical-align: middle;
            cursor: pointer;
            transition: 0.3s;
            border-radius: 3px;
        }
        svg.arrow:hover {
            background: lightgray;
        }
        div.piece {
            float: left;
            width: 52px;
            text-align: center;
            background-color: transparent;
            font-size: 15px;
            cursor: pointer;
            border-radius: 3px;
            border: solid 1px transparent;
            padding: 10px 0;
        }
        div.piece:hover {
            border-color: white;
        }
        div.piece:first-of-type, div.piece:last-of-type {
            opacity: 0.5;
        }
        div.piece:hover {
            border-color: gray;
        }
        div.piece.selected {
            color: white;
            background-color: darkorange;
        }
    </style>

    <script>
        var me = this;
        this.headText = "yyyy年代"
        this.items = [];
        
        /// <var type="Date" />
        this.value; //選択中の値（それは表示範囲にない場合もある）
        this.nowYear = -1;

        //----------------------------------------
        //初期化

        function init(){
            for(var i=0; i<12; i++){
                me.items.push({text:i, name:"p"+i, selected:false, value:0 });
            }

            var d = new Date();
            me.value = new Date(d.getFullYear(), 0);
            setNowYear(d.getFullYear());
        }
        init();
        
        //----------------------------------------
        //イベント処理用

        this.pieceClicked = function(event){
            var nm = event.target.getAttribute("name");
            var index = Number(nm.substring(1, nm.length));
            setValue(me.items[index].value);
        }
        this.arrowClicked = function(event){
            var add = event.target.getAttribute("add");
            if(add == undefined){
                add = event.target.parentNode.getAttribute("add");
            }
            setNowYear(me.nowYear + Number(add)*10);
        }

        //----------------------------------------

        function setNowYear(year){
            var year = year - year % 10;
            if(me.nowYear == year) return;

            me.nowYear = year;
            me.headText = ("0000" + year).substr(-4) + "年代";

            var day = new Date(year-1, 0, 1, 0, 0, 0, 0);
            me.items.forEach(function(item){
                item.text = day.getFullYear() + "";
                item.value = day.getTime();
                day.setFullYear(day.getFullYear() + 1);
            });

            setItemSelected();
        }

        function setItemSelected(){
            me.items.forEach(function(item){
                item.selected = item.value == me.value.getTime();
            });
        }

        function setValue(millis){
            if(me.value.getTime() == millis) return;

            me.value.setTime(millis);
            setNowYear(me.value.getFullYear());
            setItemSelected();

            me.update();
            me.onValueChanged(me);
        }

        //----------------------------------------
        //公開メソッド

        /**
         * 選択年取得
         * @return {Date} 取得値
         */
        this.getValue = function(){
            return new Date(me.value.getTime());
        }
        /**
         * 選択年設定
         * @param {Date} value 設定値
         */
        this.setValue = function(value){
            var tmp = new Date(value.getFullYear(), 0);
            setValue(tmp.getTime());
        }

        //----------------------------------------
        //個別イベントコールバック

        /**
         * 値の変更時に呼び出されます（初期化時は呼ばれません）
         * @param sender このインスタンス
         */
        this.onValueChanged = this.opts.onvaluechanged ? this.opts.onvaluechanged : function(sender){};

    </script>
</my-YCalendar>


<!-- 時刻選択コンボボックス
    属性 無し
-->
<my-TimeCombo>
    <div>
        <select ref="hourSelect" onchange={selectionChanged}>
            <option each={ val in options.h }>{val}</option>
        </select><span style="margin-left:1px">時</span>
        <select ref="minSelect1" onchange={selectionChanged}>
            <option each={ val in options.m1 }>{val}</option>
        </select><select ref="minSelect2" onchange={selectionChanged} style="margin-left:1px">
            <option each={ val in options.m2 }>{val}</option>
        </select><span style="margin-left:1px">分<span></span>
    </div>

    <style>
        :scope{
            display:block;
        }
        select {
            font-size:15px;
        }
    </style>

    <script>
        var me = this;

        var OptionsDef = {
            h:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23],
            m1:[0,1,2,3,4,5],
            m2:[0,1,2,3,4,5,6,7,8,9]
        };

        //時間間隔別コンボボックス内容リスト
        //（h:時コンボ, m1:10分コンボ, m2:1分コンボ）
        var OptionsList = {
            "1"  :OptionsDef,
            "10" :{ h:OptionsDef.h, m1:OptionsDef.m1, m2:[0] },
            "60" :{ h:OptionsDef.h, m1:[0], m2:[0] }
        }

        this.interval = 1;
        this.options = OptionsList[this.interval];

        //----------------------------------------
        //イベント処理

        /** コンボ変更 */
        this.selectionChanged = function(){
            me.onValueChanged(me);
        }

        //----------------------------------------
        //公開メソッド

        /**
         * 時取得
         * @return {number} 取得値
         */
        this.getHours = function(){
            var opt = me.refs.hourSelect.options[me.refs.hourSelect.selectedIndex];
            return Number(opt.value);
        }
        /**
         * 分取得
         * @return {number} 取得値
         */
        this.getMinutes = function(){
            var opt1 = me.refs.minSelect1.options[me.refs.minSelect1.selectedIndex];
            var opt2 = me.refs.minSelect2.options[me.refs.minSelect2.selectedIndex];
            return Number(opt1.value) * 10 + Number(opt2.value);
        }
        /**
         * 時分設定
         * @param {number} hour 時間
         * @param {number} min 分
         */
        this.setValue = function(hour, min){
            function set(select, value){
                for(var i=0; i<select.options.length; i++){
                    if(select.options[i].value == value){
                        select.selectedIndex = i; break;
                    }
                }
            }
            set(me.refs.hourSelect, hour);
            
            set(me.refs.minSelect1, Math.floor(min / 10));
            set(me.refs.minSelect2, min % 10);
        }

        /**
         * 時間間隔設定
         * OptionsListにあるもののみ設定可
         * @param {number} 時間間隔（分単位）
         */
        this.setTimeInterval = function(value){
            if(me.interval != value){
                me.interval = value;
                me.options = OptionsList[value];
                me.update();
            }
        }

        //----------------------------------------
        //個別イベントコールバック

        /**
         * 値の変更時に呼び出されます（初期化時は呼ばれません）
         * @param sender このインスタンス
         */
        this.onValueChanged = this.opts.onvaluechanged ? this.opts.onvaluechanged : function(sender){};

    </script>

</my-TimeCombo>


<!-- 日時選択パネル。ダイアログ利用できます。
    属性
        {boolean} buttonvisible OKキャンセルボタン表示有無
        {boolean} timevisible 時刻選択表示有無
-->
<my-CalendarTimePanel>

    <div style="text-align:center;padding:10px">
        <my-Calendar ref="calendar" style="margin:0 0 5px 0;" onvaluechanged={valueChanged}></my-Calendar>
        <my-TimeCombo ref="timeCombo" style={ timeVisible ? "" : "display:none" } onvaluechanged={valueChanged} style="font-size:14px"></my-TimeCombo>
        <div if={buttonVisible}>
            <my-Button tag={true} onbuttonpress={clicked}>OK</my-Button><my-Button tag={false} onbuttonpress={clicked}>キャンセル</my-Button>
        </div>
    </div>

    <style scoped>
        :scope {
            display: block;
        }
        my-Button {
            margin: 20px 10px 0 10px;
            width: 100px;
        }
    </style>

    <script>
        var me = this;
        this.buttonVisible = !("" + this.opts.buttonvisible == "false");
        this.timeVisible = !("" + this.opts.timevisible == "false");

        //----------------------------------------
        //イベント処理

        /** ボタン押下 */
        this.clicked = function(sender){
            if(sender.getTag()){
                me.onOkClick();
            }else{
                me.onCancelClick();
            }
        }

        /** カレンダーと時刻指定の選択変更 */
        this.valueChanged = function(sender){
            me.onValueChanged(me);
        }

        //----------------------------------------
        //公開メソッド

        /**
         * 選択値取得
         * @return {Date} 取得値
         */
        this.getValue = function(){
            var d = me.refs.calendar.getValue();
            d.setHours(me.refs.timeCombo.getHours());
            d.setMinutes(me.refs.timeCombo.getMinutes());
            return d;
        }
        
        /**
         * 選択値設定
         * @param {Date} value 設定値
         */
        this.setValue = function(date){
            me.refs.calendar.setValue(date);
            me.refs.timeCombo.setValue(date.getHours(), date.getMinutes());
        }

        /**
         * 時間間隔設定
         * @param {number} value 設定値（分）
         */
        this.setTimeInterval = function(interval){
            me.refs.timeCombo.setTimeInterval(interval);
        }
        
        /**
         * 時刻部表示設定
         * @param {boolean} value 設定値
         */
        this.setTimeVisible = function(value){
            if(me.timeVisible != value){
                me.timeVisible = value;
                me.update();
            }
        }

        //----------------------------------------
        //イベントコールバック

        /**
          * OKボタン押下時に呼ばれます。
          * 既定ではdialog.close(true)を呼び出します。
          * @param sender このインスタンス
          */
        this.onOkClick = function(sender){ dialog.close(true) };
        
        /**
          * キャンセルボタン押下時に呼ばれます。
          * 既定ではdialog.close(false)を呼び出します。
          * @param sender このインスタンス
          */
        this.onCancelClick = function(sender){ dialog.close(false) };
        
        /**
         * 値の変更時に呼び出されます（初期化時は呼ばれません）
         * @param sender このインスタンス
         */
        this.onValueChanged = this.opts.onvaluechanged ? this.opts.onvaluechanged : function(sender){};

    </script>
</my-CalendarTimePanel>

<!-- 月選択パネル。ダイアログ利用できます。
    属性
        {boolean} buttonvisible OKキャンセルボタン表示有無
-->
<my-CalendarMonthPanel>
    <div style="text-align:center;padding:10px">
        <my-MCalendar ref="calendar" style="margin:0 0 5px 0;" onvaluechanged={valueChanged}></my-MCalendar>
        <div if={buttonVisible}>
            <my-Button tag={true} onbuttonpress={clicked}>OK</my-Button><my-Button tag={false} onbuttonpress={clicked}>キャンセル</my-Button>
        </div>
    </div>

    <style scoped>
        :scope {
            display: block;
        }
        my-Button {
            margin: 20px 10px 0 10px;
            width: 100px;
        }
    </style>

    <script>
        var me = this;
        this.buttonVisible = !("" + this.opts.buttonvisible == "false");

        //----------------------------------------
        //イベント処理

        /** ボタン押下 */
        this.clicked = function(sender){
            if(sender.getTag()){ me.onOkClick(); }
            else{ me.onCancelClick(); }
        }
        /** カレンダーと時刻指定の選択変更 */
        this.valueChanged = function(sender){
            me.onValueChanged(me);
        }

        //----------------------------------------
        //公開メソッド

        /**
         * 選択値取得
         * @return {Date} 取得値
         */
        this.getValue = function(){
            var d = me.refs.calendar.getValue();
            return d;
        }
        /**
         * 選択値設定
         * @param {Date} value 設定値
         */
        this.setValue = function(date){
            me.refs.calendar.setValue(date);
        }

        //----------------------------------------
        //イベントコールバック

        /**
          * OKボタン押下時に呼ばれます。
          * 既定ではdialog.close(true)を呼び出します。
          * @param sender このインスタンス
          */
        this.onOkClick = function(sender){ dialog.close(true) };
        /**
          * キャンセルボタン押下時に呼ばれます。
          * 既定ではdialog.close(false)を呼び出します。
          * @param sender このインスタンス
          */
        this.onCancelClick = function(sender){ dialog.close(false) };
        /**
         * 値の変更時に呼び出されます（初期化時は呼ばれません）
         * @param sender このインスタンス
         */
        this.onValueChanged = this.opts.onvaluechanged ? this.opts.onvaluechanged : function(sender){};
    </script>
</my-CalendarMonthPanel>

<!-- 年選択パネル。ダイアログ利用できます。
    属性
        {boolean} buttonvisible OKキャンセルボタン表示有無
-->
<my-CalendarYearPanel>
    <div style="text-align:center;padding:10px">
        <my-YCalendar ref="calendar" style="margin:0 0 5px 0;" onvaluechanged={valueChanged}></my-YCalendar>
        <div if={buttonVisible}>
            <my-Button tag={true} onbuttonpress={clicked}>OK</my-Button><my-Button tag={false} onbuttonpress={clicked}>キャンセル</my-Button>
        </div>
    </div>

    <style scoped>
        :scope {
            display: block;
        }
        my-Button {
            margin: 20px 10px 0 10px;
            width: 100px;
        }
    </style>

    <script>
        var me = this;
        this.buttonVisible = !("" + this.opts.buttonvisible == "false");

        //----------------------------------------
        //イベント処理

        /** ボタン押下 */
        this.clicked = function(sender){
            if(sender.getTag()){ me.onOkClick(); }
            else{ me.onCancelClick(); }
        }
        /** カレンダーと時刻指定の選択変更 */
        this.valueChanged = function(sender){
            me.onValueChanged(me);
        }

        //----------------------------------------
        //公開メソッド

        /**
         * 選択値取得
         * @return {Date} 取得値
         */
        this.getValue = function(){
            var d = me.refs.calendar.getValue();
            return d;
        }
        /**
         * 選択値設定
         * @param {Date} value 設定値
         */
        this.setValue = function(date){
            me.refs.calendar.setValue(date);
        }

        //----------------------------------------
        //イベントコールバック

        /**
          * OKボタン押下時に呼ばれます。
          * 既定ではdialog.close(true)を呼び出します。
          * @param sender このインスタンス
          */
        this.onOkClick = function(sender){ dialog.close(true) };
        /**
          * キャンセルボタン押下時に呼ばれます。
          * 既定ではdialog.close(false)を呼び出します。
          * @param sender このインスタンス
          */
        this.onCancelClick = function(sender){ dialog.close(false) };
        /**
         * 値の変更時に呼び出されます（初期化時は呼ばれません）
         * @param sender このインスタンス
         */
        this.onValueChanged = this.opts.onvaluechanged ? this.opts.onvaluechanged : function(sender){};
    </script>
</my-CalendarYearPanel>

<!--
    日指定ボックス
    属性 {string} type 種別（day | month | year）
-->
<my-DatePicker>
    <span class="timeBox">
        <span  onclick={iconClicked}><span ref="timeStr">0000/00/00 00:00</span>&nbsp;&nbsp;<i class="fa fa-calendar" aria-hidden="true" /></span>
        <div class="dtpPnl" ref="pnl_base" onclick={pnlClicked}>
            <my-Calendar  class="dtpCalendar" if={type=="day"}   ref="pnl_day" onvaluechanged={pnlValueChanged} ></my-Calendar>
            <my-MCalendar class="dtpCalendar" if={type=="month"} ref="pnl_month" onvaluechanged={pnlValueChanged} ></my-MCalendar>
            <my-YCalendar class="dtpCalendar" if={type=="year"}  ref="pnl_year" onvaluechanged={pnlValueChanged} ></my-YCalendar>
        </div>
    </span>

    <style scoped>
        .timeBox {
            position: relative;
            border: solid 1px gray;
            border-radius: 3px;
            text-align: right;
            padding: 1px 5px;
            cursor: default;
        }
        .dtpPnl {
            text-align: center;
            position: absolute;
            border: solid 1px gray;
            top: 25px;
            left: -1px;
            z-index: 3;
            display: none;
            visibility: hidden;
        }
        .dtpPnl.visible, .dtpCalendar.visible {
            display: block;
            visibility:visible;
        }
        .dtpCalendar {
            display:none;
            visibility:hidden;
        }
    </style>

    <script>
        var me = this;
        var clickFlg = false;

        this.type = this.opts.type;
        //this.value = new Date();

        var TimeFormats={
            day  : "yyyy年MM月dd日",
            month: "yyyy年MM月",
            year : "yyyy年   "
        };

        this.on('mount', function(){
            document.addEventListener("click", function(){
                if(!clickFlg){
                    calendarUnVisible();
                }
                clickFlg = false;
            });
        })

        function calendarUnVisible(){
            var pnl = me.refs["pnl_" + me.type].root;
            if(pnl.classList.contains("visible")){
                pnl.classList.remove("visible");
            }
        }

        this.iconClicked = function(event){
            //種別毎のコントロール表示状態
            var pnl = me.refs["pnl_" + me.type].root;
            if(!pnl.classList.contains("visible")){
                pnl.classList.add("visible");
            }
            
            if(!me.refs.pnl_base.classList.contains("visible")){
                me.refs.pnl_base.classList.add("visible");
            }
            clickFlg = true;
        }

        this.pnlClicked = function(){
            clickFlg = true;
        }

        this.pnlValueChanged = function(sender){
            me.refs.timeStr.innerText = common.date.format(sender.getValue(), TimeFormats[me.type]);
            //日時選択したらすぐ閉じることに
            calendarUnVisible();
            clickFlg = false;
        }

        this.close = function(){
            me.refs.pnl_base.classList.remove("visible");
        }

        //----------------------------------------
        //公開メソッド

        this.getValue = function(){
            //return new Date(me.value.getTime());
            var pnl = me.refs["pnl_" + me.type];
            return pnl.getValue();
        }

        this.setValue = function(value){
            var pnl = me.refs["pnl_" + me.type];
            pnl.setValue(value);
            //me.pnlValueChanged(pnl);
            me.refs.timeStr.innerText = common.date.format(pnl.getValue(), TimeFormats[me.type]);
        }
    </script>
</my-DatePicker>